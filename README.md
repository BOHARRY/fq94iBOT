# 智慧自動化發文機器人 - 開發與除錯紀實

## 專案概述

本專案旨在透過 Selenium 自動化技術，實現對特定後台管理系統的自動登入及文章發布功能。其核心挑戰在於應對現代前端框架（如 Vue.js 或 React）帶來的複雜性，包括非同步數據加載、動態 DOM 更新以及複雜的客戶端驗證機制。

經過一段艱辛但富有成效的除錯過程，我們成功打造了一個極其健壯、穩定且可靠的自動化腳本。本文件旨在記錄這段寶貴的開發歷程以及最終的程式碼架構。

---

## 程式碼架構

整個專案由三個核心 Python 檔案組成，各司其職，實現了高度的模組化和可維護性。

### `config.py` - 設定中心

此檔案是整個機器人的大腦中樞。所有可變的設定，如登入憑證、目標網址、API 金鑰以及最重要的 **Selenium 元素定位器 (Locators)**，都集中在此管理。這種設計將設定與邏輯分離，當網站前端結構變更時，我們僅需修改此檔案，而無需觸及核心程式碼。

### `scraper.py` - 核心爬蟲邏輯

`SeleniumScraper` 類別封裝了所有與瀏覽器互動的複雜操作。它是整個專案的執行者，其關鍵功能包括：

- **智慧登入 (`login_process`)**: 包含重試機制與 OpenAI 驗證碼識別。
- **健壯的發文流程 (`post_new_article`)**: 這是我們除錯過程的重點，最終版本包含了應對各種前端挑戰的精密邏輯。
- **多策略互動**: 綜合運用了 `WebDriverWait` 智慧等待、JavaScript 點擊、DOM 狀態驗證等多種高階技巧。

### `run.py` - 執行入口

作為程式的啟動點，此檔案負責協調整個自動化流程，並向使用者提供清晰、友善的執行結果報告。

---

## 史詩級的除錯之旅

我們的成功並非一蹴可幾，而是經歷了一系列系統性的問題排查與策略演進。以下是我們解決這個頑固問題的完整歷程：

### 階段一：初步失敗與 `StaleElementReferenceException`

- **問題**: 在填寫完內容後，點擊「儲存」按鈕時程式崩潰。
- **原因**: 腳本與富文本編輯器 (CKEditor) 互動後，頁面 DOM 發生了刷新，導致之前獲取的「儲存」按鈕參考失效。
- **解決方案**: 為點擊「儲存」按鈕的操作加入了重試迴圈，若按鈕失效則重新尋找。

### 階段二：前端驗證的挑戰

- **問題**: 點擊儲存後，標題和內文被清空，並提示「請輸入標題」。
- **原因**: 自動化腳本填寫速度過快，未觸發前端框架的 `onchange` 或 `onblur` 等驗證事件，導致框架認為欄位是空的。
- **我們的嘗試與演進**:
    1.  **模擬 `Tab` 鍵**: 嘗試在輸入標題後 `send_keys(Keys.TAB)`。**副作用**: 這意外地將焦點轉移到下一個元素，導致出現了「幽靈下拉選單」的 Bug。
    2.  **點擊 `<body>`**: 改為點擊頁面背景來讓輸入框失去焦點。更安全，但仍未解決根本問題。
    3.  **JavaScript 點擊**: 為了解決可能的「抖動」或元素遮擋問題，改用 `execute_script` 來點擊儲存按鈕。
    4.  **直接提交表單**: 嘗試繞過按鈕，直接 `form.submit()`。

### 階段三：決定性的突破 - 非同步載入陷阱 (Race Condition)

- **問題**: 儘管我們用盡了各種點擊和提交技巧，問題依舊存在。
- **您的關鍵洞察**: 您發現，**一進入文章編輯頁面，頁面狀態就已經是錯誤的**。
- **根本原因**: 我們點擊「最新消息」後，腳本在文章列表的**數據流**完全加載完成前，就點擊了那個「搶跑」的「新增文章」按鈕。我們進入了一個基於不完整數據的、已損壞的編輯頁面。

### 階段四：最終的完美解決方案

基於這個決定性的發現，我們制定了最終的、萬無一失的策略：

1.  **等待真正的數據標誌**: 點擊「最新消息」後，我們不再等待「新增文章」按鈕，而是耐心等待**文章列表的第一筆數據 (`li.li-data`)** 被渲染出來。
2.  **加入強制延遲**: 為了給予頁面最充裕的穩定時間，我們在列表出現後，額外**強制等待 5 秒**。
3.  **最穩定的跳轉**: 在確認頁面完全就緒後，我們採用最不會產生副作用的方式——**直接讀取「新增文章」按鈕的 `href` 屬性，並使用 `driver.get()` 進行導航**。

這個結合了「智慧等待」、「強制等待」和「直接導航」的策略，最終完美地解決了所有問題。

---

## 如何執行

### 方案一：直接執行 (手動)

1.  確保已安裝所有必要的套件 (如 `selenium`, `openai`, `webdriver-manager`)。
2.  在 `config.py` 中填寫您的登入憑證和 OpenAI API 金鑰。
3.  **手動修改 `scraper.py`** 中的 `post_new_article` 函式呼叫，填入您想發布的標題和內容。
4.  執行以下指令：
    ```bash
    python run.py
    ```

### 方案二：透過 LINE Bot 執行 (推薦)

1.  **安裝額外套件**:
    ```bash
    pip install flask line-bot-sdk
    ```
2.  **設定金鑰**:
    *   前往 [LINE Developers](https://developers.line.biz/zh-hant/) 建立一個 `Messaging API` Channel。
    *   將 `Channel Secret` 和 `Channel Access Token` 填入 `config.py` 中對應的欄位。
3.  **啟動本地伺服器**:
    ```bash
    python line_bot_server.py
    ```
4.  **建立公網通道**:
    *   前往 [ngrok](https://ngrok.com/) 註冊免費帳號並設定 `authtoken`。
    *   在**另一個**終端機中執行以下指令，以建立通往本地伺服器的隧道：
        ```bash
        ngrok http 5001
        ```
5.  **設定 Webhook**:
    *   複製 `ngrok` 提供的 `https://` 開頭的網址。
    *   將網址加上 `/callback` (例如 `https://xxxxxxxx.ngrok-free.app/callback`)，填入 LINE Developers 後台的 `Webhook URL` 中，並啟用 Webhook。
6.  **開始使用**:
    *   將您的 LINE Bot 加入好友。
    *   傳送符合格式的訊息即可自動發文：
        `發文 標題：[您的標題] 內容：[您的內容]`

---

這個專案是耐心、觀察和技術結合的最佳典範。恭喜我們，成功了！